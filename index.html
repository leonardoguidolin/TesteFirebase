<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contador de "Leandro"</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial; background: linear-gradient(180deg, #0b1023, #0a0f1e 40%, #070b16); color: var(--fg); }
    .wrap { max-width: 720px; margin: 40px auto; padding: 0 16px; }
    .card { background: linear-gradient(180deg, #0b1222, #0d1426); border: 1px solid #1f2937; border-radius: 18px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-weight: 750; letter-spacing: .2px; }
    p.sub { margin: 0 0 16px; color: var(--muted); }
    .counter { display:flex; align-items:center; gap:20px; margin: 14px 0 6px; }
    .count { font-size: 64px; font-weight: 800; line-height: 1; letter-spacing: -1px; padding: 8px 14px; border-radius: 12px; background: #0a1222; border:1px solid #1f2937; min-width: 110px; text-align:center; }
    button { appearance: none; border: 1px solid #1f2937; background: #101827; color: var(--fg); padding: 14px 18px; border-radius: 14px; font-size: 16px; cursor: pointer; transition: transform .05s ease, background .2s ease; }
    button:active { transform: translateY(1px); }
    .btnPlus { font-weight: 800; font-size: 18px; background: #0e1a2f; }
    .btnPlus span { font-size: 22px; margin-right: 6px; }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .ok { color: var(--accent); }
    .error { color: #f87171; }
    .status { margin-top: 12px; min-height: 22px; color: var(--muted); }
    .hint { margin-top: 18px; font-size: 13px; color: var(--muted); }
    code { background:#0a1222; border:1px solid #1f2937; padding:3px 6px; border-radius:6px; }
      .streak { margin-top: 10px; font-weight: 600; font-size: 18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Contador de vezes que me chamam de <span class="ok">‚ÄúLeandro‚Äù</span></h1>
      <p class="sub">Clique no <strong>+</strong> para registrar cada ocorr√™ncia. O valor √© salvo no Firestore em tempo real.</p>

      <div class="counter">
        <div class="count" id="count">0</div>
        <div class="row">
          <button id="btnPlus" class="btnPlus"><span>Ôºã</span>Adicionar 1</button>
        </div>
      </div>

      <div id="daysSince" class="streak">‚Äî</div>
      <div class="status" id="status">Conectando ao banco‚Ä¶</div>

      <p class="hint">Dica: o contador usa o documento <code>counters/leandro</code> com o campo <code>count</code>. Se o doc n√£o existir, ser√° criado com <code>0</code>.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      runTransaction,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    // üëâ Substitua pela sua config, se necess√°rio (mantive a que voc√™ j√° usa)
    const firebaseConfig = {
      apiKey: "AIzaSyDm-1F3odGeqFYk6dIcR2QM_hQFFQ1WfvU",
      authDomain: "bancoteste-a09ee.firebaseapp.com",
      projectId: "bancoteste-a09ee",
      storageBucket: "bancoteste-a09ee.appspot.com",
      messagingSenderId: "938322850076",
      appId: "1:938322850076:web:bb83901cac6c4c3f4a8ad9",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const btnPlus = document.getElementById('btnPlus');
    const daysSinceEl = document.getElementById('daysSince');

    let lastUpdated = null; // guardar√° o Date da √∫ltima ocorr√™ncia

    // Documento √∫nico para o contador
    const counterRef = doc(db, 'counters', 'leandro');

    // Garante que o documento exista
    async function ensureDoc() {
      const snap = await getDoc(counterRef);
      if (!snap.exists()) {
        await setDoc(counterRef, { count: 0, updatedAt: new Date() });
      }
    }

    // Observa em tempo real
    onSnapshot(counterRef, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        countEl.textContent = Number(data.count || 0);
        statusEl.textContent = `Sincronizado ‚Ä¢ √öltima atualiza√ß√£o salva`;

        // Define lastUpdated a partir do Firestore (Timestamp ou Date)
        const ts = data.updatedAt;
        lastUpdated = ts && typeof ts.toDate === 'function' ? ts.toDate() : (ts ? new Date(ts) : null);
        renderDaysSince();
      } else {
        countEl.textContent = '0';
        statusEl.textContent = 'Documento n√£o encontrado (criando...)';
        ensureDoc().catch(err => status(err.message));
      }
    }, (err) => status(`Erro no listener: ${err.message}`));
            return;
          }
          const current = Number(snap.data().count || 0);
          transaction.update(counterRef, { count: current + 1, updatedAt: new Date() });
        });
        status('Valor incrementado e salvo.');
      } catch (err) {
        status(`Erro ao incrementar: ${err.message}`, true);
      }
    });

    function status(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (isError ? 'error' : '');
    }

    function renderDaysSince() {
      if (!lastUpdated) {
        daysSinceEl.textContent = '‚Äî';
        return;
      }
      const now = new Date();
      const ms = now - lastUpdated;
      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      daysSinceEl.textContent = `${days} dia${days === 1 ? '' : 's'} sem ocorr√™ncias`;
    }

    // Inicializa documento na primeira carga
    ensureDoc().catch(err => status(`Erro ao criar doc: ${err.message}`, true));

    // Atualiza o texto de "x dias sem ocorr√™ncias" todo minuto
    setInterval(renderDaysSince, 60 * 1000);
  </script>
</body>
</html>
