<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Projetos de Alunos</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    form {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top: 5px;
      margin-bottom: 15px;
      padding: 10px;
      box-sizing: border-box;
    }
    ul { list-style: none; padding: 0; }
    li { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; }
    #perfilAluno {
      background: #fff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Sistema de Projetos Acadêmicos</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <input type="text" id="loginUser" placeholder="Usuário" />
    <input type="password" id="loginPass" placeholder="Senha" />
    <button id="btnLogin">Entrar</button>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" class="hidden">
    <h2>Painel do Admin</h2>
    <button id="btnLogout">Sair</button>

    <form id="formAluno">
      <h3>Cadastrar Aluno</h3>
      <input type="text" id="nomeAluno" placeholder="Nome do aluno" required />
      <input type="email" id="emailAluno" placeholder="Email do aluno" required />
      <button type="submit">Salvar Aluno</button>
    </form>

    <form id="formProjeto">
      <h3>Cadastrar Projeto</h3>
      <input type="text" id="tituloProjeto" placeholder="Título" required />
      <textarea id="descricaoProjeto" placeholder="Descrição"></textarea>
      <input type="text" id="videoUrl" placeholder="Link do vídeo (YouTube)" />
      <label>Selecionar Alunos</label>
      <select id="alunosSelect" multiple></select>
      <button type="submit">Salvar Projeto</button>
    </form>
  </div>

  <!-- PÚBLICO -->
  <div id="publicView">
    <h2>Projetos Disponíveis</h2>
    <ul id="listaProjetos"></ul>

    <h2>Alunos</h2>
    <ul id="listaAlunos"></ul>

    <div id="perfilAluno" class="hidden">
      <h3>Perfil do Aluno</h3>
      <p><strong>Nome:</strong> <span id="perfilNome"></span></p>
      <p><strong>Email:</strong> <span id="perfilEmail"></span></p>
      <h4>Projetos Participantes</h4>
      <ul id="projetosDoAluno"></ul>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm-1F3odGeqFYk6dIcR2QM_hQFFQ1WfvU",
      authDomain: "bancoteste-a09ee.firebaseapp.com",
      projectId: "bancoteste-a09ee",
      storageBucket: "bancoteste-a09ee.appspot.com",
      messagingSenderId: "938322850076",
      appId: "1:938322850076:web:bb83901cac6c4c3f4a8ad9",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const USER_ADMIN = "admin";
    const PASS_ADMIN = "123456";

    const loginSection = document.getElementById("loginSection");
    const adminPanel = document.getElementById("adminPanel");
    const publicView = document.getElementById("publicView");

    const listaAlunos = document.getElementById("listaAlunos");
    const perfilAluno = document.getElementById("perfilAluno");
    const perfilNome = document.getElementById("perfilNome");
    const perfilEmail = document.getElementById("perfilEmail");
    const projetosDoAluno = document.getElementById("projetosDoAluno");

    let loggedIn = false;

    function atualizarVisibilidade() {
      loginSection.classList.toggle("hidden", loggedIn);
      adminPanel.classList.toggle("hidden", !loggedIn);
      publicView.classList.toggle("hidden", false);
    }

    document.getElementById("btnLogin").addEventListener("click", () => {
      const user = document.getElementById("loginUser").value.trim();
      const pass = document.getElementById("loginPass").value;
      if (user === USER_ADMIN && pass === PASS_ADMIN) {
        loggedIn = true;
        atualizarVisibilidade();
        carregarAlunos();
        carregarProjetos();
        carregarListaAlunos();
      } else {
        alert("Usuário ou senha incorretos!");
      }
    });

    document.getElementById("btnLogout").addEventListener("click", () => {
      loggedIn = false;
      atualizarVisibilidade();
      carregarProjetos();
      carregarListaAlunos();
    });

    document.getElementById("formAluno").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("nomeAluno").value.trim();
      const email = document.getElementById("emailAluno").value.trim();
      if (!nome || !email) {
        alert("Preencha todos os campos do aluno.");
        return;
      }
      try {
        await addDoc(collection(db, "usuarios"), {
          nome,
          email,
          projetos: [],
        });
        alert("Aluno cadastrado!");
        e.target.reset();
        carregarAlunos();
        carregarListaAlunos();
      } catch (err) {
        alert("Erro ao cadastrar aluno: " + err.message);
      }
    });

    document.getElementById("formProjeto").addEventListener("submit", async (e) => {
      e.preventDefault();
      const titulo = document.getElementById("tituloProjeto").value.trim();
      const descricao = document.getElementById("descricaoProjeto").value.trim();
      const videoUrl = document.getElementById("videoUrl").value.trim();
      const alunosSelecionados = [...document.getElementById("alunosSelect").selectedOptions].map(opt => opt.value);
      if (!titulo) {
        alert("Título do projeto é obrigatório.");
        return;
      }
      try {
        const projetoRef = await addDoc(collection(db, "projetos"), {
          titulo,
          descricao,
          videoUrl,
          pdfUrl: "https://exemplo.com",
          alunos: alunosSelecionados,
        });
        for (const alunoId of alunosSelecionados) {
          const alunoRef = doc(db, "usuarios", alunoId);
          const alunoSnap = await getDoc(alunoRef);
          if (alunoSnap.exists()) {
            const dados = alunoSnap.data();
            await updateDoc(alunoRef, {
              projetos: [...(dados.projetos || []), projetoRef.id],
            });
          }
        }
        alert("Projeto cadastrado!");
        e.target.reset();
        carregarProjetos();
        carregarListaAlunos();
      } catch (err) {
        alert("Erro ao cadastrar projeto: " + err.message);
      }
    });

    async function carregarAlunos() {
      if (!loggedIn) return;
      const alunos = await getDocs(collection(db, "usuarios"));
      const select = document.getElementById("alunosSelect");
      select.innerHTML = "";
      alunos.forEach((doc) => {
        const aluno = doc.data();
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = aluno.nome;
        select.appendChild(option);
      });
    }

    async function carregarProjetos() {
      const lista = document.getElementById("listaProjetos");
      lista.innerHTML = "";
      const projetos = await getDocs(collection(db, "projetos"));
      for (const docSnap of projetos.docs) {
        const proj = docSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `<strong>${proj.titulo}</strong><br>${proj.descricao}<br>
          ${proj.videoUrl ? `<a href="${proj.videoUrl}" target="_blank">Ver vídeo</a>` : ""}`;
        if (proj.alunos && proj.alunos.length > 0) {
          const nomesAlunos = await Promise.all(
            proj.alunos.map(async (id) => {
              const alunoSnap = await getDoc(doc(db, "usuarios", id));
              return alunoSnap.exists() ? alunoSnap.data().nome : "Desconhecido";
            })
          );
          li.innerHTML += `<br><em>Participantes:</em> ${nomesAlunos.join(", ")}`;
        }
        lista.appendChild(li);
      }
    }

    async function carregarListaAlunos() {
      listaAlunos.innerHTML = "";
      const alunos = await getDocs(collection(db, "usuarios"));
      alunos.forEach((docSnap) => {
        const aluno = docSnap.data();
        const li = document.createElement("li");
        li.textContent = aluno.nome;
        li.addEventListener("click", () => mostrarPerfilAluno(docSnap.id, aluno));
        listaAlunos.appendChild(li);
      });
    }

    async function mostrarPerfilAluno(id, aluno) {
      perfilAluno.classList.remove("hidden");
      perfilNome.textContent = aluno.nome;
      perfilEmail.textContent = aluno.email;
      projetosDoAluno.innerHTML = "";
      for (const projId of aluno.projetos || []) {
        const projSnap = await getDoc(doc(db, "projetos", projId));
        if (projSnap.exists()) {
          const proj = projSnap.data();
          const li = document.createElement("li");
          li.innerHTML = `<strong>${proj.titulo}</strong><br>${proj.descricao}<br>
            ${proj.videoUrl ? `<a href="${proj.videoUrl}" target="_blank">Ver vídeo</a>` : ""}`;
          projetosDoAluno.appendChild(li);
        }
      }
    }

    atualizarVisibilidade();
    carregarProjetos();
    carregarListaAlunos();
  </script>
</body>
</html>
