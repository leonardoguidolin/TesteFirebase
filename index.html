<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Projetos de Alunos</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    form {
      background: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top: 5px;
      margin-bottom: 15px;
      padding: 10px;
      box-sizing: border-box;
    }
    ul { list-style: none; padding: 0; }
    li { background: #fff; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    a { color: blue; text-decoration: underline; cursor: pointer; }
    #perfilAluno, #adminPanel, #loginSection, #publicView {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Sistema de Projetos Acadêmicos</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <input type="text" id="loginUser" placeholder="Usuário" />
    <input type="password" id="loginPass" placeholder="Senha" />
    <button id="btnLogin">Entrar</button>
  </div>

  <!-- ADMIN -->
  <div id="adminPanel" style="display:none;">
    <h2>Painel do Admin</h2>
    <button id="btnLogout">Sair</button>

    <form id="formAluno">
      <h3>Cadastrar Aluno</h3>
      <input type="text" id="nomeAluno" placeholder="Nome do aluno" required />
      <input type="email" id="emailAluno" placeholder="Email do aluno" required />
      <button type="submit">Salvar Aluno</button>
    </form>

    <form id="formProjeto">
      <h3>Cadastrar Projeto</h3>
      <input type="text" id="tituloProjeto" placeholder="Título" required />
      <textarea id="descricaoProjeto" placeholder="Descrição"></textarea>
      <input type="text" id="videoUrl" placeholder="Link do vídeo (YouTube)" />
      <label>Selecionar Alunos</label>
      <select id="alunosSelect" multiple size="5"></select>

      <label>Upload do PDF do projeto (máx 5MB):</label>
      <input type="file" id="pdfFile" accept="application/pdf" />

      <button type="submit">Salvar Projeto</button>
    </form>
  </div>

  <!-- PÚBLICO -->
  <div id="publicView">
    <h2>Projetos Disponíveis</h2>
    <ul id="listaProjetos"></ul>
  </div>

  <!-- PERFIL DO ALUNO -->
  <div id="perfilAluno" style="display:none;">
    <button id="btnVoltar">← Voltar</button>
    <h1>Perfil do Aluno</h1>
    <div id="dadosAluno"></div>
    <h2>Projetos do Aluno</h2>
    <ul id="listaProjetosAluno"></ul>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    doc,
    getDoc,
    getDocs,
    updateDoc,
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDm-1F3odGeqFYk6dIcR2QM_hQFFQ1WfvU",
    authDomain: "bancoteste-a09ee.firebaseapp.com",
    projectId: "bancoteste-a09ee",
    storageBucket: "bancoteste-a09ee.appspot.com",
    messagingSenderId: "938322850076",
    appId: "1:938322850076:web:bb83901cac6c4c3f4a8ad9",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const USER_ADMIN = "admin";
  const PASS_ADMIN = "123456";

  const loginSection = document.getElementById("loginSection");
  const adminPanel = document.getElementById("adminPanel");
  const publicView = document.getElementById("publicView");
  const perfilAluno = document.getElementById("perfilAluno");
  const dadosAluno = document.getElementById("dadosAluno");
  const listaProjetosAluno = document.getElementById("listaProjetosAluno");

  let loggedIn = false;

  function showView(view) {
    loginSection.style.display = (view === 'login') ? 'block' : 'none';
    adminPanel.style.display = (view === 'admin') ? 'block' : 'none';
    publicView.style.display = (view === 'public') ? 'block' : 'none';
    perfilAluno.style.display = (view === 'perfil') ? 'block' : 'none';
  }

  // Atualizar select de alunos no admin
  async function carregarAlunos() {
    if (!loggedIn) return;
    const alunos = await getDocs(collection(db, "usuarios"));
    const select = document.getElementById("alunosSelect");
    select.innerHTML = "";
    alunos.forEach((doc) => {
      const aluno = doc.data();
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = aluno.nome;
      select.appendChild(option);
    });
  }

  // Carregar e mostrar projetos (lista pública)
  async function carregarProjetos() {
    const lista = document.getElementById("listaProjetos");
    lista.innerHTML = "";

    const projetos = await getDocs(collection(db, "projetos"));
    for (const docSnap of projetos.docs) {
      const proj = docSnap.data();
      const li = document.createElement("li");

      // Links dos participantes para perfil na mesma página
      let participantesHTML = "";
      if (proj.alunos && proj.alunos.length > 0) {
        const nomesAlunos = await Promise.all(
          proj.alunos.map(async (id) => {
            const alunoSnap = await getDoc(doc(db, "usuarios", id));
            if (alunoSnap.exists()) {
              const alunoData = alunoSnap.data();
              return `<a href="#" class="linkAluno" data-id="${id}">${alunoData.nome}</a>`;
            } else {
              return "Desconhecido";
            }
          })
        );
        participantesHTML = `<br><em>Participantes:</em> ${nomesAlunos.join(", ")}`;
      }

      li.innerHTML = `
        <strong>${proj.titulo}</strong><br>
        ${proj.descricao}<br>
        ${proj.videoUrl ? `<a href="${proj.videoUrl}" target="_blank">Ver vídeo</a><br>` : ""}
        ${proj.pdfUrl ? `<a href="${proj.pdfUrl}" target="_blank" download>Download do PDF</a>` : ""}
        ${participantesHTML}
      `;
      lista.appendChild(li);
    }
  }

  // Mostrar perfil do aluno dentro da mesma página
  async function mostrarPerfilAluno(alunoId) {
    showView('perfil');
    dadosAluno.innerHTML = "Carregando...";
    listaProjetosAluno.innerHTML = "";

    const alunoRef = doc(db, "usuarios", alunoId);
    const alunoSnap = await getDoc(alunoRef);
    if (!alunoSnap.exists()) {
      dadosAluno.innerHTML = "<p>Aluno não encontrado.</p>";
      return;
    }
    const aluno = alunoSnap.data();
    dadosAluno.innerHTML = `
      <h2>${aluno.nome}</h2>
      <p>Email: ${aluno.email}</p>
    `;

    if (!aluno.projetos || aluno.projetos.length === 0) {
      listaProjetosAluno.innerHTML = "<p>Aluno não participou de projetos.</p>";
      return;
    }

    for (const projetoId of aluno.projetos) {
      const projetoRef = doc(db, "projetos", projetoId);
      const projetoSnap = await getDoc(projetoRef);
      if (projetoSnap.exists()) {
        const proj = projetoSnap.data();
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${proj.titulo}</strong><br>
          ${proj.descricao}<br>
          ${proj.videoUrl ? `<a href="${proj.videoUrl}" target="_blank">Ver vídeo</a><br>` : ""}
          ${proj.pdfUrl ? `<a href="${proj.pdfUrl}" target="_blank" download>Download do PDF</a>` : ""}
        `;
        listaProjetosAluno.appendChild(li);
      }
    }
  }

  // Eventos

  document.getElementById("btnLogin").addEventListener("click", () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value;

    if (user === USER_ADMIN && pass === PASS_ADMIN) {
      loggedIn = true;
      showView('admin');
      carregarAlunos();
      carregarProjetos();
    } else {
      alert("Usuário ou senha incorretos!");
    }
  });

  document.getElementById("btnLogout").addEventListener("click", () => {
    loggedIn = false;
    showView('public');
    carregarProjetos();
  });

  document.getElementById("formAluno").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("nomeAluno").value.trim();
    const email = document.getElementById("emailAluno").value.trim();

    if (!nome || !email) {
      alert("Preencha todos os campos do aluno.");
      return;
    }

    try {
      await addDoc(collection(db, "usuarios"), {
        nome,
        email,
        projetos: [],
      });
      alert("Aluno cadastrado!");
      e.target.reset();
      carregarAlunos();
    } catch (err) {
      alert("Erro ao cadastrar aluno: " + err.message);
    }
  });

  document.getElementById("formProjeto").addEventListener("submit", async (e) => {
    e.preventDefault();

    const titulo = document.getElementById("tituloProjeto").value.trim();
    const descricao = document.getElementById("descricaoProjeto").value.trim();
    const videoUrl = document.getElementById("videoUrl").value.trim();
    const alunosSelecionados = [...document.getElementById("alunosSelect").selectedOptions].map(opt => opt.value);
    const pdfInput = document.getElementById("pdfFile");
    const arquivoPDF = pdfInput.files[0];

    if (!titulo) {
      alert("Título do projeto é obrigatório.");
      return;
    }

    let pdfUrl = "";

    if (arquivoPDF) {
      if (arquivoPDF.size > 5 * 1024 * 1024) {
        alert("Arquivo muito grande. Máximo 5MB.");
        return;
      }

      try {
        const storageRef = ref(storage, 'projetos_pdf/' + Date.now() + '_' + arquivoPDF.name);
        await uploadBytes(storageRef, arquivoPDF);
        pdfUrl = await getDownloadURL(storageRef);
      } catch (err) {
        alert("Erro ao fazer upload do PDF: " + err.message);
        return;
      }
    }

    try {
      const projetoRef = await addDoc(collection(db, "projetos"), {
        titulo,
        descricao,
        videoUrl,
        pdfUrl,
        alunos: alunosSelecionados,
      });

      for (const alunoId of alunosSelecionados) {
        const alunoRef = doc(db, "usuarios", alunoId);
        const alunoSnap = await getDoc(alunoRef);
        if (alunoSnap.exists()) {
          const dados = alunoSnap.data();
          await updateDoc(alunoRef, {
            projetos: [...(dados.projetos || []), projetoRef.id],
          });
        }
      }

      alert("Projeto cadastrado!");
      e.target.reset();
      carregarProjetos();
    } catch (err) {
      alert("Erro ao cadastrar projeto: " + err.message);
    }
  });

  // Voltar do perfil para a lista pública
  document.getElementById("btnVoltar").addEventListener("click", () => {
    showView(loggedIn ? 'admin' : 'public');
  });

  // Delegação para links dos alunos nos projetos públicos
  document.getElementById("listaProjetos").addEventListener("click", (e) => {
    if (e.target.classList.contains("linkAluno")) {
      e.preventDefault();
      const alunoId = e.target.getAttribute("data-id");
      mostrarPerfilAluno(alunoId);
    }
  });

  // Inicializa exibindo tela pública e carregando projetos
  showView('public');
  carregarProjetos();

</script>
</body>
</html>
